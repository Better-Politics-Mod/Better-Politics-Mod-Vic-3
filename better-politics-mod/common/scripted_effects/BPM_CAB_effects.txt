

bpm_fix_cabinet_pool = {
    while = {
        count = 10
        random_in_list = {
            variable = bpm_CAB_char_select_pool
            limit = {
                OR = {
                    owner = {
                        any_interest_group = {
                            this = scope:actor
                        }
                    }
                    is_character_alive = no
                }
            }
            save_scope_as = actor
        }
        if = {
            limit = {
                exists = scope:actor
                owner = {
                    any_interest_group = {
                        this = scope:actor
                    }
                }
            }
            remove_list_variable = {
                name = bpm_CAB_char_select_pool
                target = scope:actor
            }
        }
    }
}

bpm_pick_cabinet_minister = {
    every_interest_group = {
        limit = {
            bpm_ig_enabled = yes
            is_marginal = no
        }
        set_variable = {
            name = bpm_cabinet_interest_group_luck_factor
            value = { 0 10 }
        }
    }
    ordered_interest_group = {
        limit = {
            bpm_ig_enabled = yes
            is_marginal = no
        }
        min = 0
        max = 1

        order_by = bpm_cabinet_character_pool_ig_weight
        
        save_scope_as = ranig
    }

    if = {
        limit = {
            NOT = { has_variable_list = bpm_CAB_char_select_pool }
            scope:ranig.leader ?= {
                NOT = {
                    has_variable = bpm_cabinet_minister
                }
            }
        }
        scope:ranig.leader ?= {
            set_variable = bpm_send_to_void_if_not_anchored
        }
        add_to_variable_list = {
            name = bpm_CAB_char_select_pool
            target = scope:ranig.leader
        }
    }
    else_if = {
        limit = {
            exists = scope:ranig
        }
        if = {
            limit = {
                NOT = { is_target_in_variable_list = { name = bpm_CAB_char_select_pool target = scope:ranig.leader } }
                scope:ranig.leader ?= {
                    NOT = {
                        has_variable = bpm_cabinet_minister
                    }
                }
            }
            scope:ranig.leader ?= {
                set_variable = bpm_send_to_void_if_not_anchored
            }
            add_to_variable_list = {
                name = bpm_CAB_char_select_pool
                target = scope:ranig.leader
            }
        }
        else = {
            create_character = {
                interest_group = scope:ranig
                age = 18
                on_created = {
                    place_character_in_void = 10000
                }
                save_scope_as = ranchar
            }
            add_to_variable_list = {
                name = bpm_CAB_char_select_pool
                target = scope:ranchar
            }
        }
    }
}

bpm_choose_hog = {
    if = {
        limit = {
            OR = {
                has_law = law_type:law_monarchy
                has_law = law_type:law_council_republic
            }
            
        }
        random_interest_group = {
            limit = {
                bpm_is_strongest_ig_in_government = yes
                bpm_ig_enabled = yes
            }
            save_scope_as = ranig
        }

        set_variable = {
            name = bpm_headofgov
            value = scope:ranig.leader
        }
    }
    else = {

        set_variable = {
            name = bpm_headofgov
            value = ruler
        }
    }
    bpm_reload_institution_modifiers_hog = yes
}

bpm_fill_cabinet_pool = {
    if = {
        limit = {
            # only the player has a cabinet pool
            # the AI should use bpm_cab_fill_positions
            is_player = yes
        }
        bpm_pick_cabinet_minister = yes
        while = {
            limit  = {
                variable_list_size = {
                    name = bpm_CAB_char_select_pool
                    value <= 9
                }
            }
            bpm_pick_cabinet_minister = yes
            bpm_fix_cabinet_pool = yes
        }
    }

}

bpm_initialize_cabinet = {
    bpm_fill_cabinet_pool = yes

    set_variable = bpm_has_cabinet

    if = {
        limit = {
            is_player = no
        }
        bpm_cab_fill_positions = yes
    }


    set_variable = {
        name = bpm_cached_antagonism
        value = 0
    }
    set_variable = {
        name = bpm_cached_antagonism_raw
        value = 0
    }
    set_variable = {
        name = bpm_cab_synergy
        value = 1
    }
    bpm_choose_hog = yes

    bpm_reload_institution_modifiers = yes
    bpm_reload_cabinet_picks_expectation = yes
}

bpm_cab_get_random_inst = {
    if = {
        limit = {
            NOT = { has_variable = bpm_instpicker_overload }
        }
        set_variable = {
            name = bpm_instpicker_overload
            value = 0
        }
    }
    change_variable = {
        name = bpm_instpicker_overload
        add = 1
    }
    if = {
        limit = {
            var:bpm_instpicker_overload < 5
        }
        if = {
            limit = {
                scope:bpm_temp_inp_num_to_inst = 0 
            }
            set_variable = {
                name = bpm_temp_out_num_to_inst
                value = institution:institution_colonial_affairs
            }
        }
        else_if = {
            limit = {
                scope:bpm_temp_inp_num_to_inst = 1 
            }
            set_variable = {
                name = bpm_temp_out_num_to_inst
                value = institution:institution_social_security
            }
        }
        else_if = {
            limit = {
                scope:bpm_temp_inp_num_to_inst = 2 
            }
            set_variable = {
                name = bpm_temp_out_num_to_inst
                value = institution:institution_workplace_safety
            }
        }
        else_if = {
            limit = {
                scope:bpm_temp_inp_num_to_inst = 3 
            }
            set_variable = {
                name = bpm_temp_out_num_to_inst
                value = institution:institution_schools
            }
        }
        else_if = {
            limit = {
                scope:bpm_temp_inp_num_to_inst = 4 
            }
            set_variable = {
                name = bpm_temp_out_num_to_inst
                value = institution:institution_police
            }
        }
        else_if = {
            limit = {
                scope:bpm_temp_inp_num_to_inst = 5 
            }
            set_variable = {
                name = bpm_temp_out_num_to_inst
                value = institution:institution_health_system
            }
        }
        else_if = {
            limit = {
                scope:bpm_temp_inp_num_to_inst = 6 
            }
            set_variable = {
                name = bpm_temp_out_num_to_inst
                value = institution:institution_home_affairs
            }
        }
        else_if = {
            limit = {
                scope:bpm_temp_inp_num_to_inst = 7 
            }
            set_variable = {
                name = bpm_temp_out_num_to_inst
                value = institution:institution_centralization
            }
        }
        else_if = {
            limit = {
                scope:bpm_temp_inp_num_to_inst = 8 
            }
            set_variable = {
                name = bpm_temp_out_num_to_inst
                value = institution:institution_suffrage
            }
        }
        else_if = {
            limit = {
                scope:bpm_temp_inp_num_to_inst = 9 
            }
            set_variable = {
                name = bpm_temp_out_num_to_inst
                value = institution:institution_culture
            }
        }    
        if = {
            limit = {
                NOT = { 
                    has_institution = var:bpm_temp_out_num_to_inst.type
                }
                # repeat if institution is not present
                # this is a bit of a hack to avoid infinite loops
                save_scope_value_as = {
                    name = bpm_temp_inp_num_to_inst
                    value = { 
                        value = scope:bpm_temp_inp_num_to_inst
                        add = 1
                        modulo = 10
                    }
                }
                bpm_cab_get_random_inst = yes
            }
        }
    }
}   

# -- Cabinet Register Institution (9) --
bpm_get_character_in_cabinet_position = {
    bpm_get_character_in_cabinet_position_subp = { INST = colonial_affairs }
    bpm_get_character_in_cabinet_position_subp = { INST = social_security }
    bpm_get_character_in_cabinet_position_subp = { INST = workplace_safety }
    bpm_get_character_in_cabinet_position_subp = { INST = schools }
    bpm_get_character_in_cabinet_position_subp = { INST = police }
    bpm_get_character_in_cabinet_position_subp = { INST = health_system }
    bpm_get_character_in_cabinet_position_subp = { INST = home_affairs }
    bpm_get_character_in_cabinet_position_subp = { INST = centralization }
    bpm_get_character_in_cabinet_position_subp = { INST = suffrage }
    bpm_get_character_in_cabinet_position_subp = { INST = culture }
}

bpm_get_character_in_cabinet_position_subp = {
    if = {
        limit = {
            scope:bpm_institution_to_check ?= institution:institution_$INST$.type
        }
        var:bpm_is_institution_$INST$ = {
            save_scope_as = bpm_cab_char
        }
    }
}