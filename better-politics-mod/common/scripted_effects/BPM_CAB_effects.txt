

bpm_fix_cabinet_pool = {
    while = {
        count = 10
        random_in_list = {
            variable = bpm_CAB_char_select_pool
            limit = {
                OR = {
                    owner = {
                        any_interest_group = {
                            this = scope:actor
                        }
                    }
                    is_character_alive = no
                }
            }
            save_scope_as = actor
        }
        if = {
            limit = {
                exists = scope:actor
                owner = {
                    any_interest_group = {
                        this = scope:actor
                    }
                }
            }
            remove_list_variable = {
                name = bpm_CAB_char_select_pool
                target = scope:actor
            }
        }
    }
}

bpm_pick_cabinet_minister = {
    every_interest_group = {
        limit = {
            bpm_ig_enabled = yes
            is_marginal = no
        }
        set_variable = {
            name = bpm_cabinet_interest_group_luck_factor
            value = { 0 10 }
        }
    }
    ordered_interest_group = {
        limit = {
            bpm_ig_enabled = yes
            is_marginal = no
        }
        min = 0
        max = 1

        order_by = bpm_cabinet_character_pool_ig_weight
        
        save_scope_as = ranig
    }

    if = {
        limit = {
            NOT = { has_variable_list = bpm_CAB_char_select_pool }
            scope:ranig.leader ?= {
                NOT = {
                    has_variable = bpm_cabinet_minister
                }
            }
        }
        scope:ranig.leader ?= {
            set_variable = bpm_send_to_void_if_not_anchored
        }
        add_to_variable_list = {
            name = bpm_CAB_char_select_pool
            target = scope:ranig.leader
        }
    }
    else_if = {
        limit = {
            exists = scope:ranig
        }
        if = {
            limit = {
                NOT = { is_target_in_variable_list = { name = bpm_CAB_char_select_pool target = scope:ranig.leader } }
                scope:ranig.leader ?= {
                    NOT = {
                        has_variable = bpm_cabinet_minister
                    }
                }
            }
            scope:ranig.leader ?= {
                set_variable = bpm_send_to_void_if_not_anchored
            }
            add_to_variable_list = {
                name = bpm_CAB_char_select_pool
                target = scope:ranig.leader
            }
        }
        else = {
            create_character = {
                interest_group = scope:ranig
                age = 18
                on_created = {
                    place_character_in_void = 10000
                }
                save_scope_as = ranchar
            }
            add_to_variable_list = {
                name = bpm_CAB_char_select_pool
                target = scope:ranchar
            }
        }
    }
}

bpm_choose_hog = {
    if = {
        limit = {
            OR = {
                has_law = law_type:law_monarchy
                has_law = law_type:law_council_republic
            }
            
        }
        random_interest_group = {
            limit = {
                bpm_is_strongest_ig_in_government = yes
                bpm_ig_enabled = yes
            }
            save_scope_as = ranig
        }

        set_variable = {
            name = bpm_headofgov
            value = scope:ranig.leader
        }
    }
    else = {

        set_variable = {
            name = bpm_headofgov
            value = ruler
        }
    }
    bpm_reload_institution_modifiers_hog = yes
}

bpm_fill_cabinet_pool = {
    if = {
        limit = {
            # only the player has a cabinet pool
            # the AI should use bpm_cab_fill_positions
            is_player = yes
        }
        bpm_pick_cabinet_minister = yes
        while = {
            limit  = {
                variable_list_size = {
                    name = bpm_CAB_char_select_pool
                    value <= 9
                }
            }
            bpm_pick_cabinet_minister = yes
            bpm_fix_cabinet_pool = yes
        }
    }

}

bpm_initialize_cabinet = {
    bpm_fill_cabinet_pool = yes

    set_variable = bpm_has_cabinet

    if = {
        limit = {
            is_player = no
        }
        bpm_cab_fill_positions = yes
    }


    set_variable = {
        name = bpm_cached_antagonism
        value = 0
    }
    set_variable = {
        name = bpm_cached_antagonism_raw
        value = 0
    }
    set_variable = {
        name = bpm_cab_synergy
        value = 1
    }
    bpm_choose_hog = yes

    bpm_reload_institution_modifiers = yes
    bpm_reload_cabinet_picks_expectation = yes
}

bpm_cab_get_random_inst = {
    bpm_cab_add_inst_to_varlist_if_valid = { VARLIST = bpm_cab_inst_list INST = colonial_affairs }
    bpm_cab_add_inst_to_varlist_if_valid = { VARLIST = bpm_cab_inst_list INST = social_security }
    bpm_cab_add_inst_to_varlist_if_valid = { VARLIST = bpm_cab_inst_list INST = workplace_safety }
    bpm_cab_add_inst_to_varlist_if_valid = { VARLIST = bpm_cab_inst_list INST = schools }
    bpm_cab_add_inst_to_varlist_if_valid = { VARLIST = bpm_cab_inst_list INST = police }
    bpm_cab_add_inst_to_varlist_if_valid = { VARLIST = bpm_cab_inst_list INST = health_system }
    bpm_cab_add_inst_to_varlist_if_valid = { VARLIST = bpm_cab_inst_list INST = home_affairs }
    bpm_cab_add_inst_to_varlist_if_valid = { VARLIST = bpm_cab_inst_list INST = centralization }
    bpm_cab_add_inst_to_varlist_if_valid = { VARLIST = bpm_cab_inst_list INST = suffrage }
    bpm_cab_add_inst_to_varlist_if_valid = { VARLIST = bpm_cab_inst_list INST = culture }
    random_in_list = {
        variable = bpm_cab_inst_list
        save_scope_as = bpm_found_inst
    }
    set_variable = {
        name = bpm_temp_out_num_to_inst
        value = scope:bpm_found_inst
    }
}   

bpm_cab_add_inst_to_varlist_if_valid = {
    if = {
        limit = {
            has_institution = institution:institution_$INST$.type
        }
        add_to_variable_list = {
            name = $VARLIST$
            target = institution:institution_$INST$
        }
    }
}

# -- Cabinet Register Institution (9) --
bpm_get_character_in_cabinet_position = {
    bpm_get_character_in_cabinet_position_subp = { INST = colonial_affairs }
    bpm_get_character_in_cabinet_position_subp = { INST = social_security }
    bpm_get_character_in_cabinet_position_subp = { INST = workplace_safety }
    bpm_get_character_in_cabinet_position_subp = { INST = schools }
    bpm_get_character_in_cabinet_position_subp = { INST = police }
    bpm_get_character_in_cabinet_position_subp = { INST = health_system }
    bpm_get_character_in_cabinet_position_subp = { INST = home_affairs }
    bpm_get_character_in_cabinet_position_subp = { INST = centralization }
    bpm_get_character_in_cabinet_position_subp = { INST = suffrage }
    bpm_get_character_in_cabinet_position_subp = { INST = culture }
}

bpm_get_character_in_cabinet_position_subp = {
    if = {
        limit = {
            scope:bpm_institution_to_check ?= institution:institution_$INST$.type
        }
        var:bpm_is_institution_$INST$ = {
            save_scope_as = bpm_cab_char
        }
    }
}

bpm_fire_cabinet_minister = {
    custom_tooltip = {
        text = bpm_remove_from_cabinet_effect_tt
        bpm_remove_character_from_cabinet = yes
    }

    if = {
        limit = {
            popularity > 0
        }
        add_radicals = {
            value = {
                value = popularity
                divide = 100
                multiply = 0.5
            }
            interest_group = interest_group
        }
    }
    else = {
        add_loyalists = {
            value = {
                value = popularity
                divide = 100
                multiply = -0.2
            }
        }
    }

    interest_group = {
        add_modifier = {
            modifier = bpm_recently_removed_from_cabinet
            months = short_modifier_time
            is_decaying = yes
        }
    }
}