bpm_setup_decree_negotiation = {
	if = {
		limit = {
			enacting_any_law = yes
		}
		cancel_enactment = yes
	}
	set_variable = bpm_negotiation_banner_visible
	add_modifier = {
		name = bpm_in_negotiation
	}
	remove_variable = bpm_negotiation_type_constitution
	clear_variable_list = bpm_negotiation_targets
	clear_variable_list = bpm_negotiation_decree_concessions
	add_to_variable_list = {
		name = bpm_negotiation_targets
		target = scope:bpm_selected_law.type
	}
	every_interest_group = {

		# clear 
		remove_variable = bpm_pm_promised_ig

		save_scope_as = selected_ig
		owner = { every_in_list = {
			variable = bpm_negotiation_targets
			save_scope_as = selected_law_type
			scope:selected_ig = {
				set_variable = {
					name = bpm_negotiation_support_raw_cached
					value = bpm_negotiation_support_raw
				}		
			}
		} }
	}
	set_variable = bpm_negotiation_type_decree
}

bpm_cache_support_for_target_laws = {
	every_interest_group = {
		save_scope_as = selected_ig
		set_variable = {
			name = bpm_negotiation_support_raw_cached
			value = 0
		}
		owner = { every_in_list = {
			variable = bpm_negotiation_targets
			save_scope_as = selected_law_type
			scope:selected_ig = {
				change_variable = {
					name = bpm_negotiation_support_raw_cached
					add = bpm_negotiation_support_raw
				}		
			}
		} }
	}
}

bpm_end_decree_negotiation = {
	remove_modifier = bpm_in_negotiation
	remove_variable = bpm_negotiation_banner_visible
	remove_variable = bpm_negotiation_type_decree
	clear_variable_list = bpm_negotiation_targets
}

bpm_complete_decree_negotiation = {
	bpm_end_decree_negotiation = yes
	activate_law = var:bpm_decree_cooldown
	hidden_effect = { 
		bpm_determine_coup_severity = yes
	}
	save_scope_as = associated_country
	var:bpm_decree_cooldown = { 
		bpm_codification_set_decree = yes
	}
}

bpm_end_constitutional_drafting = {
	remove_modifier = bpm_in_negotiation
	remove_variable = bpm_negotiation_banner_visible
	remove_variable = bpm_negotiation_type_constitution
}

bpm_approve_draft_constitution = {
	bpm_end_constitutional_drafting = yes
	remove_modifier = bpm_in_negotiation
	add_modifier = bpm_block_law_cancel
	every_interest_group = {
		if = {
			limit = {
				bpm_draft_support >= 50
			}
			add_ideology = ideology_constitution_supporter
		}
		else_if = {
			limit = {
				bpm_draft_support <= -50
			}
			add_ideology = ideology_constitution_opponent
		}
		else_if = {
			limit = {
				bpm_draft_support > -50
				bpm_draft_support < 0
			}
			add_ideology = ideology_constitution_wary
		}
		else_if = {
			limit = {
				bpm_draft_support >= 0
				bpm_draft_support < 50
			}
			add_ideology = ideology_constitution_reluctant
		}
	}
	start_enactment = law_type:law_repeatable_politics_approve_constitution
}

bpm_constitution_failed = {
	if = {
		limit = {
			NOT = {
				exists = currently_enacting_law.type
			}
			any_interest_group = {
				OR = {
					has_ideology = ideology:ideology_constitution_opponent
					has_ideology = ideology:ideology_constitution_supporter
					has_ideology = ideology:ideology_constitution_wary
					has_ideology = ideology:ideology_constitution_reluctant
				}
			}
		}
		every_interest_group = {
			if = {
				limit = {
					has_ideology = ideology:ideology_constitution_supporter
				}
				remove_ideology = ideology_constitution_supporter
			}
			else_if = {
				limit = {
					has_ideology = ideology:ideology_constitution_opponent
				}
				remove_ideology = ideology_constitution_opponent
			}
			else_if = {
				limit = {
					has_ideology = ideology:ideology_constitution_wary
				}
				remove_ideology = ideology_constitution_wary
			}
			else_if = {
				limit = {
					has_ideology = ideology:ideology_constitution_reluctant
				}
				remove_ideology = ideology_constitution_reluctant
			}
		}	
	}
}

bpm_end_draft_constitution_enactment = {
	remove_modifier = bpm_block_law_cancel
	save_scope_as = country
	every_interest_group = {
		if = {
			limit = {
				has_ideology = ideology:ideology_constitution_supporter
			}
			remove_ideology = ideology_constitution_supporter
		}
		else_if = {
			limit = {
				has_ideology = ideology:ideology_constitution_opponent
			}
			remove_ideology = ideology_constitution_opponent
		}
		else_if = {
			limit = {
				has_ideology = ideology:ideology_constitution_wary
			}
			remove_ideology = ideology_constitution_wary
		}
		else_if = {
			limit = {
				has_ideology = ideology:ideology_constitution_reluctant
			}
			remove_ideology = ideology_constitution_reluctant
		}
	}
	every_active_law = {
		type = {
			bpm_codification_set_traditional = yes
		}
	}
	every_in_list = {
		variable = bpm_negotiation_targets
		save_scope_as = selected_law_type
		scope:country = {
			bpm_enact_law = { law = scope:selected_law_type level = constitutional }
		}
	}
	save_scope_as = associated_country

	set_variable = {
		name = bpm_negotiation_type_constitution_cd
		days = 730
	}
	clear_variable_list = bpm_negotiation_targets

}

bpm_setup_constitutional_drafting = {
	if = {
		limit = {
			enacting_any_law = yes
		}
		cancel_enactment = yes
	}
	set_variable = bpm_negotiation_banner_visible
	add_modifier = {
		name = bpm_in_negotiation
	}
	remove_variable = bpm_negotiation_type_decree
	clear_variable_list = bpm_negotiation_targets
	clear_variable_list = bpm_negotiation_decree_concessions
	set_variable = bpm_negotiation_type_constitution
 
}